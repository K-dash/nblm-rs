name: Publish Rust Crates

on:
  release:
    types:
      - published
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify tag matches crate version
        id: verify
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          CLI_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="nblm-cli") | .version')
          CORE_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="nblm-core") | .version')
          echo "Tag version: ${TAG_VERSION}"
          echo "nblm-core version: ${CORE_VERSION}"
          echo "nblm-cli version: ${CLI_VERSION}"
          if [ "${TAG_VERSION}" != "${CORE_VERSION}" ] || [ "${TAG_VERSION}" != "${CLI_VERSION}" ]; then
            echo "::error::Tag version (${TAG_VERSION}) must match crate versions (nblm-core=${CORE_VERSION}, nblm-cli=${CLI_VERSION})"
            exit 1
          fi

      - name: Publish nblm-core
        run: cargo publish -p nblm-core --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}

      - name: Wait for crate index update
        run: sleep 30

      - name: Publish nblm-cli
        run: cargo publish -p nblm-cli --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
