name: Publish Rust Crates

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag version (e.g., v0.1.3)"
        required: false
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify tag matches crate version
        id: verify
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG_VERSION="${{ inputs.tag }}"
            TAG_VERSION="${TAG_VERSION#v}"
          else
            TAG_VERSION="${GITHUB_REF_NAME#v}"
          fi
          CLI_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="nblm-cli") | .version')
          CORE_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="nblm-core") | .version')
          echo "Tag version: ${TAG_VERSION}"
          echo "nblm-core version: ${CORE_VERSION}"
          echo "nblm-cli version: ${CLI_VERSION}"
          if [ "${TAG_VERSION}" != "${CORE_VERSION}" ] || [ "${TAG_VERSION}" != "${CLI_VERSION}" ]; then
            echo "::error::Tag version (${TAG_VERSION}) must match crate versions (nblm-core=${CORE_VERSION}, nblm-cli=${CLI_VERSION})"
            exit 1
          fi

      - name: Publish nblm-core
        run: cargo publish -p nblm-core --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}

      - name: Wait for crate index update
        run: sleep 30

      - name: Publish nblm-cli
        run: cargo publish -p nblm-cli --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
